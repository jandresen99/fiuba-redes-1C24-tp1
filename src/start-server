from socket import *
import logging
from lib.utils import get_server_args
from lib.rdt_pkg import RDTPackage

logger = logging.getLogger(__name__)

def start(ip, port):
    sock = socket(AF_INET, SOCK_DGRAM)
    sock.bind((ip, port))
    logger.info("Listening on %s:%d", ip, port)

    while True:
        pkg, addr = sock.recvfrom(1024)
        pkg: RDTPackage = RDTPackage.extract(pkg)
        logger.info("Message received from %s: %s", addr, pkg)
        sock.sendto("ACK".encode(), addr)        

def main():
    args = get_server_args()

    if args.verbose:
        level = logging.DEBUG
    elif args.quiet:
        level = logging.WARNING
    else:
        level = logging.INFO

    logging.basicConfig(filename='server.log', level=level)
    ch = logging.StreamHandler()
    ch.setLevel(level)
    logger.addHandler(ch)

    start(args.host, args.port)



if __name__ == "__main__":
    main()
